# docker 化的服务器

## 如何登陆

必须使用密钥登陆docker容器。随本文档分发的`sg-docker-public-rsa`即为私钥文件。

我会告诉你一个编号X，X就是下文“如何使用”中的X。如果你对`ssh`已经很熟悉，有下表提供的信息你已经能连上服务器了😁。

| IP | 端口 | 用户名                            |私钥文件 |私钥文件密码| 用户密码 |
| ------------ | ------------ | ------------------------------- | ---|--| --|
| 校园网外使用`zerotier`配置的内网IP，校园网内用公网IP | `50000+X`    | dancer |`sg-docker-public-rsa`|`1004@SG`| `1004@SG` |

校园网外使用服务器时，需要首先配置`zerotier`:[ 《异地连接实验室服务器》](https://shimo.im/docs/8krPP3jPPhtDcWTX/)

一般而言，私钥文件都建议保存在`~/.ssh`文件夹（Windows系统中为`C:/Users/用户名/.ssh/`）中，命名随意。

接下来，请打开终端：

> 如果您的本地电脑为 Mac OS 系统，需先打开系统自带的终端（Terminal），再执行以下命令。
> 如果您的本地电脑为 Linux 系统，可直接执行以下命令。
> 如果您的本地电脑为 Windows 10 或 Windows Server 2019 系统，需先打开Windows PowerShell或者命令提示符（CMD），再执行以下命令。

1. （非Windows系统才需要）执行以下命令，赋予私钥文件仅本人可读权限：`chmod 400 <私钥的绝对路径>`。否则一定会出现"bad permissions"之类的问题。Windows系统虽然不需要更改权限，但需要密钥是保存在`C:/`盘内。

2. 执行以下命令，进行远程登录: 

   ```bash
   ssh -i <私钥的绝对路径> -p <端口> <username>@<IP address>
   ```

    比如，私钥路径为`C:\Users\wr\.ssh\sg-docker-public-rsa`， IP为`222.20.78.183`，端口为`50002`，docker容器的用户名一般为`dancer`。此时登陆命令为：

   ```bash
   ssh -i C:\Users\wr\.ssh\sg-docker-public-rsa -p 50002 dancer@222.20.78.183
   ```

   此时一般会有如下提示：

   ```bash
   Enter passphrase for key 'C:\Users\wr\.ssh\sg-docker-public-rsa':
   ```

   提示你输入私钥的密码，使用的私钥密码为`1004@SG`，输入这个密码即可。

### 好麻烦啊！有没有更方便的方法？

是有的。如果你依然想在命令行下完成工作，可以在自己的机器上的`~/.ssh/`文件夹下（如果是Windows系统，就是`C:/Users/用户名/.ssh/`）新建一个文件`config`，文件内容写入（或者在末尾添加）以下内容：

```
Host <随便一个名字>
    HostName <IP地址>
    Port <端口号>
    User <用户名>
    IdentityFile <私钥文件名>
```

注意要把其中的<>代表的内容替换为你的服务器信息，替换后得到类似这样的内容：

```
Host 11d
    HostName 222.20.78.1
    Port 50002
    User dancer
    IdentityFile ~/.ssh/sg-docker-public-rsa
```

添加这样的内容后，直接在命令行输入`ssh <你选的名字，如（11d）>` 就可以直接登陆了，应该只提示你输入密钥的密码。

#### 如果我连密钥的密码都不想输入了呢？

也不是不行，反正你有你docker容器的root权限，你自己替换一个密钥对不就行了？自己不要设置私钥的密码就行。为了保证安全，这里不提供如何替换密钥对的方法。如果你自行学会了替换密钥对，我相信你应该懂得如何保护容器安全。建议搜索“生成密钥对”，“Linux无密码登陆”等等相关内容。

#### 如果我害怕命令行，想用GUI软件呢？

目前常用的远程登陆软件主要有xshell/putty。putty的教程可以参考腾讯云的[教程](https://cloud.tencent.com/document/product/213/35699#.E4.BD.BF.E7.94.A8.E5.AF.86.E9.92.A5.E7.99.BB.E5.BD.95)，至于xshell，教程蛮多，也比较简单，可以自行查找。

## 如何使用？

一个docker容器基本上就相当于一个独立的系统。**你使用的用户为`dancer`，拥有`sudo`权限。**

你的docker容器和别人的没有关联，可以随心所欲地安装你需要的软件，不用担心破坏别人的环境。但是，你和别人的docker容器有共享数据集文件夹，处理共享的东西时，请注意不要影响别人！

`docker`容器内已经默认安装了`conda`，`opencv`, `ipython`, `jupyter nootbook`, `pytorch`, `torchvision`, `ffmpeg`等等工具，默认装的都是最新版。如果你需要其它版本的软件，直接用`conda`新建一个虚拟`Python`环境安装吧。或者干脆删了重装，反正`docker`容器内部你做主。

docker容器和真正的服务器系统之间有三种映射：文件路径映射，端口映射，用户映射。

文件路径映射如下：

| docker内路径        | 主机路径                           | 是否共享 | 备注 | 权限|
| ------------------- | ---------------------------------- | -------- | -------------------------------------------- | --- |
| `~`即`/home/dancer` | `<workspace_path>/<容器Hostname>`/ | 否       | 个人工作路径，docker容器被删除后不会被删除   | `dancer` |
| `/data/`            | `<dataset_path>/`                  | 是       | 共享路径，只能放数据集，所有人都是相同的内容，文件写操作需要`sudo` |`root`|
| 除上面外的所有路径  | 无对应                             | 否       | docker容器被删除后会消失，**不要在这里存储内容** |`root`|

由于`/data`这个路径下的东西是所有人可见的，操作这个文件夹内容时请一定当心。为了防止意外操作，我将`/data`设置为`root`权限，即在这个文件路径下面删除，新建需要在命令前面加`sudo`。简而言之，把数据集拷贝到`/data`后就不要操作了。一些人喜欢在代码里对原数据集进行删改，这样别人就没法使用你这个数据集了，请不要做这样的坏蛋。数据集是共享的，可能有很多人同时使用一个数据集。

而在`~`也就是`$home`目录下面，你随便折腾，想怎么搞就怎么搞。把docker系统搞崩了，删坏了啥的都没啥，让管理员重新开一个docker容器就行。

端口映射如下，假设你的容器是第X个：

| docker内端口 | 主机对应端口 | 备注                            |
| ------------ | ------------ | ------------------------------- |
| `22`         | `50000+X`    | ssh登陆端口，登陆容器走这个端口 |
| `8000`       | `40000+X`    | 预置的应用端口1                 |
| `8080`       | `30000+X`    | 预置的应用端口2                 |

假设对于你，X=2，那么你ssh连接服务器时使用的端口就是`50002`。你在docker容器内部启动一个服务器，使用端口为`8000`，那么你访问这个服务器使用的端口就应该是`40002`。

如果你了解docker背后的原理，你会知道，docker不是虚拟机，依然使用的是原操作系统的内核，所以除了文件路径和端口映射，用户也映射了主机的用户。Linux系统内核区分用户不是用的用户名，而是使用用户id，即`uid`和`gid`。

| docker内用户 | 主机对应用户                                                 |
| ------------ | ------------------------------------------------------------ |
| `dancer`     | 和`dancer`同`uid`用户，其实就是用来build docker image那个用户 |
| `root`       | `root`                                                       |

